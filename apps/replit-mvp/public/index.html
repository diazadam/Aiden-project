<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aiden AI Control Tower</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --bg-primary: #0a0e1a;
      --bg-secondary: #0f1419;
      --bg-tertiary: #1a1f2e;
      --bg-card: #151b26;
      --bg-input: #1e2532;
      --border-color: #2a3441;
      --border-secondary: #3d4b5c;
      --border-accent: #4f63d2;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #8792a2;
      --accent-blue: #4f63d2;
      --accent-green: #10b981;
      --accent-orange: #f59e0b;
      --accent-red: #ef4444;
      --accent-purple: #8b5cf6;
      --glow-blue: rgba(79, 99, 210, 0.3);
      --glow-green: rgba(16, 185, 129, 0.3);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body { 
      margin: 0; 
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    
    .background-grid {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: radial-gradient(circle, rgba(79, 99, 210, 0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: 0;
    }
    
    header { 
      position: relative;
      z-index: 10;
      padding: 20px 24px; 
      background: rgba(21, 27, 38, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.75rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .logo::before {
      content: "🤖";
      font-size: 2rem;
      background: none;
      -webkit-text-fill-color: unset;
    }
    
    main { 
      position: relative;
      z-index: 5;
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 32px 24px; 
    }
    
    .card { 
      background: var(--bg-card);
      border: 1px solid var(--border-color); 
      border-radius: 16px; 
      padding: 24px; 
      margin-bottom: 24px;
      box-shadow: 
        0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06),
        0 0 0 1px rgba(79, 99, 210, 0.05);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      border-color: var(--border-secondary);
      transform: translateY(-2px);
      box-shadow: 
        0 10px 25px -3px rgba(0, 0, 0, 0.1),
        0 4px 6px -2px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(79, 99, 210, 0.1);
    }
    
    .row { 
      display: flex; 
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    textarea { 
      width: 100%; 
      min-height: 120px; 
      border-radius: 12px; 
      background: var(--bg-input); 
      color: var(--text-primary); 
      border: 1px solid var(--border-color); 
      padding: 16px; 
      font-size: 15px;
      font-weight: 400;
      resize: vertical;
      font-family: inherit;
      line-height: 1.5;
      transition: all 0.3s ease;
    }
    
    textarea:focus, input:focus, button:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px var(--glow-blue);
      background: var(--bg-card);
    }
    
    input, button { 
      border-radius: 10px; 
      border: 1px solid var(--border-color); 
      background: var(--bg-input); 
      color: var(--text-primary); 
      padding: 12px 16px; 
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      transition: all 0.3s ease;
    }
    
    input:focus {
      background: var(--bg-card);
    }
    
    button { 
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    button:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s ease;
    }
    
    button:hover:before {
      left: 100%;
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    button:active:not(:disabled) {
      transform: translateY(0);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-blue) 0%, #6366f1 100%);
      border-color: var(--accent-blue);
      color: white;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(79, 99, 210, 0.3);
    }
    
    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #4338ca 0%, var(--accent-blue) 100%);
      box-shadow: 0 4px 16px rgba(79, 99, 210, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
      border-color: var(--accent-green);
      color: white;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    .btn-success:hover:not(:disabled) {
      background: linear-gradient(135deg, #047857 0%, var(--accent-green) 100%);
      box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, var(--accent-orange) 0%, #d97706 100%);
      border-color: var(--accent-orange);
      color: white;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    
    .btn-warning:hover:not(:disabled) {
      background: linear-gradient(135deg, #b45309 0%, var(--accent-orange) 100%);
      box-shadow: 0 4px 16px rgba(245, 158, 11, 0.4);
    }
    
    pre { 
      white-space: pre-wrap; 
      word-wrap: break-word; 
      background: var(--bg-input); 
      padding: 18px; 
      border-radius: 12px; 
      border: 1px solid var(--border-color); 
      margin: 16px 0 0 0;
      font-size: 14px;
      line-height: 1.6;
      overflow-x: auto;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    }
    
    .pill { 
      display: inline-flex;
      align-items: center;
      padding: 6px 14px; 
      border-radius: 20px; 
      background: var(--bg-input); 
      border: 1px solid var(--border-color); 
      font-size: 13px;
      font-weight: 600;
      gap: 8px;
      backdrop-filter: blur(10px);
    }
    
    .pill.online {
      background: rgba(16, 185, 129, 0.15);
      border-color: rgba(16, 185, 129, 0.4);
      color: var(--accent-green);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
    }
    
    .pill.offline {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.4);
      color: var(--accent-red);
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
    }
    
    .pill.pending {
      background: rgba(245, 158, 11, 0.15);
      border-color: rgba(245, 158, 11, 0.4);
      color: var(--accent-orange);
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
    }
    
    .chat-message {
      margin-bottom: 16px;
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .message-role {
      font-weight: 600;
      font-size: 14px;
    }
    
    .message-role.user {
      color: var(--accent-blue);
    }
    
    .message-role.assistant {
      color: var(--accent-green);
    }
    
    .taskcard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .input-group label {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    @media (max-width: 768px) {
      main {
        padding: 16px;
      }
      
      .row {
        flex-direction: column;
        align-items: stretch;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
    }
    
    .loading {
      position: relative;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      margin: auto;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 1s ease infinite;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
    }
    
    @keyframes spin {
      0% { transform: translateY(-50%) rotate(0deg); }
      100% { transform: translateY(-50%) rotate(360deg); }
    }

    @keyframes slideIn {
      from { 
        transform: translateX(100%); 
        opacity: 0; 
      }
      to { 
        transform: translateX(0); 
        opacity: 1; 
      }
    }

    @keyframes slideOut {
      from { 
        transform: translateX(0); 
        opacity: 1; 
      }
      to { 
        transform: translateX(100%); 
        opacity: 0; 
      }
    }
  </style>
</head>
<body>
  <div class="background-grid"></div>
  
  <header>
    <div class="logo">Aiden Control Tower</div>
    <div style="display: flex; align-items: center; gap: 16px;">
      <div id="status" class="pill">🔄 checking…</div>
    </div>
  </header>
  
  <main>
    <!-- Welcome Wizard (shown for new users) -->
    <div id="welcome-wizard" class="card" style="background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%); color: white; text-align: center; display: none;">
      <div style="margin-bottom: 24px;">
        <h1 style="margin: 0 0 12px 0; font-size: 2.5rem; font-weight: 800;">
          🚀 Welcome to Aiden Control Tower
        </h1>
        <p style="margin: 0; font-size: 18px; opacity: 0.9;">
          Build Million-Dollar Automation in Minutes, Not Months
        </p>
      </div>
      
      <div style="background: rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; margin: 20px 0; backdrop-filter: blur(10px);">
        <h3 style="margin: 0 0 12px 0;">Tell Aiden About Your Business</h3>
        <input id="business-type" placeholder="e.g., HVAC Company, Restaurant, E-commerce Store" 
               style="background: rgba(255,255,255,0.9); color: var(--bg-primary); width: 100%; margin-bottom: 12px;" />
        <button id="start-journey" class="btn-warning" style="font-size: 16px; padding: 12px 24px;">
          🎯 Create My Automation Empire
        </button>
      </div>
    </div>

    <!-- Business Setup Cards (shown after wizard) -->
    <div id="setup-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
      
      <!-- Quick Start Card -->
      <div class="card" style="background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%); color: white;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <span style="font-size: 2rem;">⚡</span>
          <h3 style="margin: 0; font-weight: 700;">Quick Start</h3>
        </div>
        <p style="margin: 0 0 16px 0; opacity: 0.9;">Launch pre-built automation templates instantly</p>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="quick-template" data-template="hvac" style="background: rgba(255,255,255,0.2); border: none; padding: 6px 12px; border-radius: 20px; color: white; font-size: 12px;">HVAC</button>
          <button class="quick-template" data-template="restaurant" style="background: rgba(255,255,255,0.2); border: none; padding: 6px 12px; border-radius: 20px; color: white; font-size: 12px;">Restaurant</button>
          <button class="quick-template" data-template="ecommerce" style="background: rgba(255,255,255,0.2); border: none; padding: 6px 12px; border-radius: 20px; color: white; font-size: 12px;">E-commerce</button>
          <button class="quick-template" data-template="healthcare" style="background: rgba(255,255,255,0.2); border: none; padding: 6px 12px; border-radius: 20px; color: white; font-size: 12px;">Healthcare</button>
        </div>
      </div>

      <!-- AI Business Consultant -->
      <div class="card" style="background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%); color: white;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <span style="font-size: 2rem;">🧠</span>
          <h3 style="margin: 0; font-weight: 700;">AI Business Consultant</h3>
        </div>
        <p style="margin: 0 0 16px 0; opacity: 0.9;">Let Aiden analyze your business and recommend the perfect automation strategy</p>
        <button id="start-consultation" class="btn-warning" style="width: 100%;">
          💼 Start Business Analysis
        </button>
      </div>

    </div>

    <!-- Advanced Capabilities Cards -->
    <div id="advanced-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
      
      <!-- Adaptive Learning -->
      <div class="card" style="background: linear-gradient(135deg, var(--accent-orange) 0%, #ea580c 100%); color: white;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <span style="font-size: 2rem;">🎓</span>
          <h3 style="margin: 0; font-weight: 700;">Teach Aiden New Skills</h3>
        </div>
        <p style="margin: 0 0 16px 0; opacity: 0.9;">Train Aiden to handle any automation pattern for your industry</p>
        <button id="teach-pattern" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); padding: 12px 24px; border-radius: 8px; color: white; font-weight: 600; width: 100%;">🎓 Teach New Pattern</button>
      </div>

      <!-- Custom Solutions -->
      <div class="card" style="background: linear-gradient(135deg, var(--accent-purple) 0%, #7c3aed 100%); color: white;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <span style="font-size: 2rem;">🎯</span>
          <h3 style="margin: 0; font-weight: 700;">Custom Solutions</h3>
        </div>
        <p style="margin: 0 0 16px 0; opacity: 0.9;">Get tailored automation solutions for your unique business needs</p>
        <button id="create-solution" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); padding: 12px 24px; border-radius: 8px; color: white; font-weight: 600; width: 100%;">🎯 Create Solution</button>
      </div>

      <!-- Website Builder -->
      <div class="card" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <span style="font-size: 2rem;">🌐</span>
          <h3 style="margin: 0; font-weight: 700;">AI Website Builder</h3>
        </div>
        <p style="margin: 0 0 16px 0; opacity: 0.9;">Create stunning websites with blog and deploy to custom domain</p>
        <button id="build-website" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); padding: 12px 24px; border-radius: 8px; color: white; font-weight: 600; width: 100%;">🌐 Build Website</button>
      </div>

      <!-- Business Intelligence -->
      <div class="card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <span style="font-size: 2rem;">📊</span>
          <h3 style="margin: 0; font-weight: 700;">Business Intelligence</h3>
        </div>
        <p style="margin: 0 0 16px 0; opacity: 0.9;">Get comprehensive reports on your automation performance</p>
        <button id="generate-report" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); padding: 12px 24px; border-radius: 8px; color: white; font-weight: 600; width: 100%;">📊 Generate Report</button>
      </div>

    </div>

    <!-- Main Chat Interface -->
    <div class="card" style="background: linear-gradient(135deg, var(--bg-card) 0%, rgba(21, 27, 38, 0.7) 100%);">
      <div style="margin-bottom: 20px;">
        <h2 style="margin: 0 0 8px 0; font-size: 1.5rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 12px;">
          🤖 <span id="chat-title">Chat with Aiden</span>
        </h2>
        <p style="margin: 0; color: var(--text-muted); font-size: 14px;" id="chat-subtitle">
          Describe what you want to automate, and Aiden will make it happen
        </p>
      </div>

      <div class="input-group">
        <label for="account" style="font-weight: 600; color: var(--text-secondary);">Business Name</label>
        <input id="account" placeholder="e.g., ACME HVAC, Mario's Pizza, TechCorp Solutions" style="background: var(--bg-input);" />
      </div>
      
      <div class="input-group" style="margin-top: 20px;">
        <label for="msg" style="font-weight: 600; color: var(--text-secondary);">What would you like to automate?</label>
        <textarea id="msg" placeholder="Try these examples:
💬 'Text customers when their appointment is confirmed'
📅 'Send booking reminders 24 hours before service'  
📊 'Create a daily sales report and email it to managers'
🔄 'Update my CRM when someone fills out a contact form'"></textarea>
      </div>

      <div class="controls" style="margin-top: 24px;">        
        <button id="send" class="btn-primary" style="min-width: 140px;">
          <span>🚀 Build This Automation</span>
        </button>
        <button id="dispatch" class="btn-success" disabled style="min-width: 160px;">
          <span>✅ Deploy Now</span>
        </button>
        <button id="save-automation" class="btn-warning" disabled style="min-width: 140px;">
          <span>💾 Save Template</span>
        </button>
      </div>
    </div>

    <div id="chat"></div>
  </main>

  <script>
    const chat = document.getElementById('chat');
    const statusEl = document.getElementById('status');
    const accountEl = document.getElementById('account');
    const msgEl = document.getElementById('msg');
    const sendBtn = document.getElementById('send');
    const dispatchBtn = document.getElementById('dispatch');
    const saveBtn = document.getElementById('save-automation');

    // New UI elements
    const welcomeWizard = document.getElementById('welcome-wizard');
    const setupCards = document.getElementById('setup-cards');
    const businessTypeInput = document.getElementById('business-type');
    const startJourneyBtn = document.getElementById('start-journey');
    const startConsultationBtn = document.getElementById('start-consultation');
    const chatTitle = document.getElementById('chat-title');
    const chatSubtitle = document.getElementById('chat-subtitle');

    let lastTaskCard = null;
    let currentBusinessType = '';
    let automationTemplates = [];

    // Business Templates Database
    const businessTemplates = {
      hvac: {
        name: "HVAC Company",
        automations: [
          "Send appointment confirmations 24 hours before service",
          "Text customers when technician is on the way",
          "Follow up after service with feedback request",
          "Send seasonal maintenance reminders"
        ],
        services: ["Twilio SMS", "Calendly", "Google Calendar", "SendGrid Email"]
      },
      restaurant: {
        name: "Restaurant",
        automations: [
          "Send order confirmations and pickup times",
          "Text when delivery driver is en route",
          "Send feedback requests after dining",
          "Daily specials notifications to loyal customers"
        ],
        services: ["Twilio SMS", "Square POS", "DoorDash API", "Mailchimp"]
      },
      ecommerce: {
        name: "E-commerce Store", 
        automations: [
          "Order confirmation and tracking updates",
          "Abandoned cart recovery sequences", 
          "Post-purchase review requests",
          "Inventory alerts for low stock items"
        ],
        services: ["Stripe", "Shopify", "SendGrid", "Twilio SMS"]
      },
      healthcare: {
        name: "Healthcare Practice",
        automations: [
          "Appointment reminders with confirm/reschedule options",
          "Pre-visit paperwork and intake forms", 
          "Post-visit care instructions and follow-ups",
          "Insurance verification reminders"
        ],
        services: ["Twilio SMS", "Practice Fusion", "HIPAA-compliant email", "Calendly"]
      }
    };

    // Initialize UI based on user state
    function initializeUI() {
      const isFirstTime = !localStorage.getItem('aidenBusinessType');
      
      if (isFirstTime) {
        welcomeWizard.style.display = 'block';
        setupCards.style.display = 'none';
      } else {
        currentBusinessType = localStorage.getItem('aidenBusinessType');
        welcomeWizard.style.display = 'none';
        setupCards.style.display = 'grid';
        updateChatForBusiness();
      }
    }

    // Update chat interface based on business type
    function updateChatForBusiness() {
      if (currentBusinessType && businessTemplates[currentBusinessType]) {
        const template = businessTemplates[currentBusinessType];
        chatTitle.textContent = `${template.name} Automation Hub`;
        chatSubtitle.textContent = `Streamline your ${template.name.toLowerCase()} operations with AI-powered automation`;
        
        // Pre-populate account field
        if (accountEl.value === '') {
          accountEl.value = template.name.toUpperCase().replace(' ', '-') + '-CLIENT';
        }
      }
    }

    // Business setup wizard
    startJourneyBtn.addEventListener('click', function() {
      const businessType = businessTypeInput.value.trim();
      if (!businessType) {
        alert('Please tell us about your business first!');
        return;
      }

      // Try to match with templates or create custom
      const matchedTemplate = findBusinessTemplate(businessType);
      
      if (matchedTemplate) {
        currentBusinessType = matchedTemplate;
        localStorage.setItem('aidenBusinessType', matchedTemplate);
      } else {
        // Create custom business type
        currentBusinessType = 'custom';
        localStorage.setItem('aidenBusinessType', 'custom');
        localStorage.setItem('customBusinessName', businessType);
      }

      // Transition to main interface
      welcomeWizard.style.display = 'none';
      setupCards.style.display = 'grid';
      updateChatForBusiness();

      // Show celebration message
      addChatMessage('assistant', 
        `🎉 Welcome to your ${businessType} automation hub! I'm Aiden, your AI automation specialist. I'll help you build powerful automations that save time and grow your business.\n\nTo get started, you can:\n• Choose a quick template below\n• Ask me to analyze your business needs\n• Or just describe what you want to automate!`
      );
    });

    // Quick template selection
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('quick-template')) {
        const template = e.target.dataset.template;
        loadBusinessTemplate(template);
      }
    });

    function loadBusinessTemplate(templateKey) {
      const template = businessTemplates[templateKey];
      if (!template) return;

      currentBusinessType = templateKey;
      localStorage.setItem('aidenBusinessType', templateKey);
      updateChatForBusiness();

      // Show template overview
      const automationList = template.automations.map((auto, i) => `${i+1}. ${auto}`).join('\n');
      const servicesList = template.services.join(', ');
      
      addChatMessage('assistant', 
        `🚀 ${template.name} Automation Template Loaded!\n\nRecommended Automations:\n${automationList}\n\nRequired Services: ${servicesList}\n\nWould you like me to:\n• Set up all these automations automatically?\n• Help you choose which ones to start with?\n• Connect you with the required services?`
      );
      
      // Update textarea with first automation as example
      msgEl.value = template.automations[0];
      msgEl.focus();
    }

    // AI Business Consultation
    startConsultationBtn.addEventListener('click', function() {
      startConsultationBtn.innerHTML = '🤔 Analyzing...';
      startConsultationBtn.disabled = true;

      // Simulate AI business analysis
      setTimeout(() => {
        const businessQuestions = [
          "What type of business do you run?",
          "What's your biggest time-waster each day?", 
          "How do you currently communicate with customers?",
          "What manual tasks slow down your team?",
          "Do you send appointment reminders manually?",
          "How do you handle customer follow-ups?",
          "What reports do you create regularly?"
        ];

        const randomQuestion = businessQuestions[Math.floor(Math.random() * businessQuestions.length)];
        
        addChatMessage('assistant', 
          `🎯 AI Business Analysis Starting!\n\nI'm going to ask you a few quick questions to understand your business and recommend the perfect automation strategy.\n\nFirst question: ${randomQuestion}\n\nJust type your answer below and I'll analyze your needs and create a custom automation plan!`
        );

        startConsultationBtn.innerHTML = '💼 Start Business Analysis';
        startConsultationBtn.disabled = false;
        
        // Focus on chat input
        msgEl.focus();
        msgEl.placeholder = 'Answer the question above to continue your business analysis...';
        
      }, 2000);
    });

    // Enhanced automation suggestion system
    function suggestAutomations(message, businessType) {
      const suggestions = [];
      const msg = message.toLowerCase();

      // Analyze message for automation opportunities
      if (msg.includes('text') || msg.includes('sms')) {
        suggestions.push('SMS automation with Twilio');
      }
      if (msg.includes('email')) {
        suggestions.push('Email automation with SendGrid');  
      }
      if (msg.includes('appointment') || msg.includes('booking')) {
        suggestions.push('Calendar integration with Calendly');
      }
      if (msg.includes('report')) {
        suggestions.push('Automated reporting dashboard');
      }
      if (msg.includes('crm') || msg.includes('customer')) {
        suggestions.push('CRM integration and updates');
      }

      return suggestions;
    }

    // Find matching business template
    function findBusinessTemplate(businessDescription) {
      const desc = businessDescription.toLowerCase();
      
      if (desc.includes('hvac') || desc.includes('heating') || desc.includes('cooling') || desc.includes('air conditioning')) {
        return 'hvac';
      }
      if (desc.includes('restaurant') || desc.includes('food') || desc.includes('cafe') || desc.includes('dining')) {
        return 'restaurant';
      }
      if (desc.includes('ecommerce') || desc.includes('online store') || desc.includes('shopify') || desc.includes('retail')) {
        return 'ecommerce';
      }
      if (desc.includes('healthcare') || desc.includes('medical') || desc.includes('clinic') || desc.includes('doctor')) {
        return 'healthcare';
      }
      
      return null;
    }

    // Check health on load
    fetch('/api/health')
      .then(r => r.json())
      .then(j => {
        statusEl.textContent = `✅ ${j.provider.toUpperCase()} Online`;
        statusEl.className = 'pill online';
      })
      .catch(() => { 
        statusEl.textContent = '❌ Offline';
        statusEl.className = 'pill offline';
      });

    // Enhanced addChatMessage function (moved to avoid duplication)

    async function ask() {
      const message = msgEl.value.trim();
      if (!message) return;
      
      const account_id = accountEl.value.trim() || null;
      sendBtn.disabled = true; 
      dispatchBtn.disabled = true; 
      lastTaskCard = null;
      
      sendBtn.classList.add('loading');
      sendBtn.innerHTML = '<span>🤔 Thinking...</span>';
      
      // Add user message
      addChatMessage('user', message);
      
      try {
        // Determine business info for superintelligence
        let business_name = null;
        let industry = null;
        
        if (currentBusinessType && businessTemplates[currentBusinessType]) {
          business_name = account_id || 'My Business';
          industry = currentBusinessType;
        }
        
        const r = await fetch('/api/chat', {
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify({
            message, 
            account_id,
            business_name,
            industry
          })
        });
        
        if (!r.ok) {
          throw new Error(`HTTP ${r.status}`);
        }
        
        const j = await r.json();
        
        // Add assistant response
        addChatMessage('assistant', j.assistant || '(no response)');
        
        // Add TaskCard if present
        if (j.taskcard) {
          lastTaskCard = j.taskcard;
          const pretty = JSON.stringify(j.taskcard, null, 2);
          addChatMessage('assistant', pretty, true);
          dispatchBtn.disabled = false;
        }
        
        msgEl.value = '';
        
      } catch (error) {
        addChatMessage('assistant', `Error: ${error.message}`);
      } finally {
        sendBtn.disabled = false;
        sendBtn.classList.remove('loading');
        sendBtn.innerHTML = '<span>💬 Ask Aiden</span>';
      }
    }

    async function dispatch() {
      if (!lastTaskCard) return;
      
      dispatchBtn.disabled = true;
      dispatchBtn.classList.add('loading');
      dispatchBtn.innerHTML = '<span>🚀 Executing...</span>';
      
      try {
        const r = await fetch('/api/task', {
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify({taskcard: lastTaskCard})
        });
        
        const j = await r.json();
        
        // Add response with better formatting
        let responseContent = '';
        if (j.status >= 200 && j.status < 300) {
          responseContent = `✅ Task executed successfully!\n\nStatus: ${j.status}\nResponse: ${j.body || 'Task completed'}`;
        } else {
          responseContent = `❌ Task execution failed\n\nStatus: ${j.status}\nError: ${j.body || j.detail || 'Unknown error'}`;
        }
        
        addChatMessage('assistant', responseContent);
        
        if (j.status >= 200 && j.status < 300) {
          lastTaskCard = null;
        }
        
      } catch (error) {
        addChatMessage('assistant', `❌ Dispatch Error: ${error.message}`);
      } finally {
        dispatchBtn.disabled = true;
        dispatchBtn.classList.remove('loading');
        dispatchBtn.innerHTML = '<span>✅ Execute Task</span>';
      }
    }

    // Event listeners
    sendBtn.onclick = ask;
    dispatchBtn.onclick = dispatch;
    
    // Enter to send message
    msgEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        ask();
      }
    });
    
    // Removed PIN functionality for streamlined UX

    // Auto-resize textarea
    msgEl.addEventListener('input', () => {
      msgEl.style.height = 'auto';
      msgEl.style.height = Math.min(msgEl.scrollHeight, 200) + 'px';
    });

    // Service Integration Helper
    function showServiceIntegration(services) {
      if (!services || services.length === 0) return;
      
      const serviceButtons = services.map(service => 
        `<button class="service-btn" data-service="${service.toLowerCase()}" style="
          background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
          color: white; border: none; padding: 8px 16px; margin: 4px;
          border-radius: 20px; font-size: 12px; cursor: pointer;
        ">🔗 Setup ${service}</button>`
      ).join('');

      addChatMessage('assistant', 
        `🔧 Required Services for Your Automation:\n\n${serviceButtons}\n\nClick any service above and I'll help you set it up instantly! I can:\n• Guide you through account creation\n• Help with API key setup\n• Configure the service for your automation\n• Test the integration`,
        false,
        true // Allow HTML
      );
    }

    // Service setup handler
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('service-btn')) {
        const service = e.target.dataset.service;
        handleServiceSetup(service);
      }
    });

    // Advanced capabilities event handlers
    document.getElementById('teach-pattern')?.addEventListener('click', function() {
      console.log('🎓 Teach Pattern clicked');
      showTeachPatternModal();
    });

    document.getElementById('create-solution')?.addEventListener('click', function() {
      console.log('🎯 Create Solution clicked');
      showCreateSolutionModal();
    });

    const websiteBtn = document.getElementById('build-website');
    console.log('🌐 Website button found:', websiteBtn);
    websiteBtn?.addEventListener('click', function(event) {
      console.log('🌐 Build Website clicked!', event);
      showWebsiteBuilderModal();
    });

    document.getElementById('generate-report')?.addEventListener('click', function() {
      console.log('📊 Generate Report clicked');
      generateBusinessReport();
    });

    function handleServiceSetup(service) {
      const setupGuides = {
        'twilio sms': {
          steps: [
            "Go to twilio.com and create a free account",
            "Verify your phone number", 
            "Get a Twilio phone number",
            "Copy your Account SID and Auth Token",
            "Paste them in the form below"
          ],
          url: "https://www.twilio.com/try-twilio"
        },
        'sendgrid email': {
          steps: [
            "Sign up at sendgrid.com (free tier: 100 emails/day)",
            "Verify your sender identity", 
            "Create an API key",
            "Copy the API key",
            "Enter it below to connect"
          ],
          url: "https://signup.sendgrid.com/"
        },
        'calendly': {
          steps: [
            "Create account at calendly.com",
            "Set up your availability",
            "Get your Calendly link",
            "Optional: Get API key for advanced features"
          ],
          url: "https://calendly.com/signup"
        }
      };

      const guide = setupGuides[service];
      if (guide) {
        const stepsList = guide.steps.map((step, i) => `${i+1}. ${step}`).join('\n');
        
        addChatMessage('assistant',
          `🚀 Setting up ${service.toUpperCase()}!\n\nQuick Setup Steps:\n${stepsList}\n\n` +
          `<a href="${guide.url}" target="_blank" style="
            display: inline-block; background: var(--accent-blue); color: white;
            padding: 10px 20px; border-radius: 8px; text-decoration: none;
            margin: 10px 0;
          ">🔗 Open ${service} Signup</a>\n\n` +
          `Once you have your credentials, just paste them here and I'll configure everything automatically!`,
          false, true
        );
      }
    }

    // Enhanced addChatMessage function with HTML support and better styling
    function addChatMessage(role, content, isTaskCard = false, allowHTML = false) {
      const div = document.createElement('div');
      div.className = 'card chat-message';
      div.style.background = isTaskCard ? 
        'linear-gradient(135deg, rgba(79, 99, 210, 0.1) 0%, var(--bg-card) 100%)' :
        (role === 'user' ? 'linear-gradient(135deg, var(--bg-card) 0%, rgba(16, 185, 129, 0.05) 100%)' : 'var(--bg-card)');
      
      const roleClass = role === 'user' ? 'user' : 'assistant';
      const icon = isTaskCard ? '⚡' : (role === 'user' ? '👤' : '🤖');
      const title = isTaskCard ? 'Generated TaskCard' : (role === 'user' ? 'You' : 'Aiden AI');
      
      div.innerHTML = `
        <div class="message-header">
          <div class="message-role ${roleClass}" style="display: flex; align-items: center; gap: 8px;">
            <span>${icon}</span>
            <span style="font-weight: 600;">${title}</span>
          </div>
          ${isTaskCard ? '<div class="pill pending">⏳ Ready to Deploy</div>' : ''}
        </div>
        <div style="
          font-size: ${isTaskCard ? '13px' : '15px'}; 
          ${isTaskCard ? 'font-family: monospace;' : ''} 
          ${allowHTML ? '' : 'white-space: pre-wrap;'}
          line-height: 1.5;
          margin-top: 12px;
        ">${allowHTML ? content : content}</div>
      `;
      
      chat.insertBefore(div, chat.firstChild);
      return div;
    }

    // Initialize the new interface
    initializeUI();

    // Show first-time user experience
    if (localStorage.getItem('aidenFirstTime') !== 'false') {
      setTimeout(() => {
        if (welcomeWizard.style.display !== 'none') {
          businessTypeInput.focus();
          // Add some sparkle animation
          businessTypeInput.style.boxShadow = '0 0 20px var(--glow-blue)';
        }
        localStorage.setItem('aidenFirstTime', 'false');
      }, 1000);
    }

    // ============================================================================
    // 🎓 ADVANCED CAPABILITIES FUNCTIONS
    // ============================================================================

    async function showTeachPatternModal() {
      const businessName = accountEl.value.trim() || 'My Business';
      const industry = currentBusinessType || 'general';

      const patternDescription = prompt(`🎓 Teach Aiden New Automation Pattern\n\nDescribe a new automation pattern you want Aiden to learn for your ${industry} business.\n\nExample: "Send weather-based service reminders that adjust based on seasonal conditions"\n\nPattern Description:`);
      
      if (!patternDescription) return;

      // Show loading state
      const teachBtn = document.getElementById('teach-pattern');
      const originalText = teachBtn.innerHTML;
      teachBtn.innerHTML = '🧠 Teaching...';
      teachBtn.disabled = true;

      try {
        const response = await fetch('/api/learn-pattern', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            business_name: businessName,
            industry: industry,
            pattern_description: patternDescription,
            account_id: businessName
          })
        });

        const result = await response.json();
        
        if (result.success) {
          addChatMessage('assistant', `🎓 **Pattern Learned Successfully!**\n\n${result.result}`);
          showSuccessMessage('Aiden learned your new automation pattern!');
        } else {
          throw new Error(result.error || 'Failed to teach pattern');
        }
      } catch (error) {
        addChatMessage('assistant', `❌ **Learning Error**: ${error.message}\n\nPlease try again or contact support.`);
      } finally {
        teachBtn.innerHTML = originalText;
        teachBtn.disabled = false;
      }
    }

    async function showCreateSolutionModal() {
      const businessName = accountEl.value.trim() || 'My Business';
      const industry = currentBusinessType || 'general';

      const clientNeed = prompt(`🎯 Create Custom Automation Solution\n\nDescribe the specific automation need or business challenge you want Aiden to solve.\n\nExample: "I need to automate follow-up sequences for customers who abandon their shopping carts, with personalized recovery messages based on their browsing history"\n\nYour Automation Need:`);
      
      if (!clientNeed) return;

      // Show loading state
      const solutionBtn = document.getElementById('create-solution');
      const originalText = solutionBtn.innerHTML;
      solutionBtn.innerHTML = '🔧 Creating...';
      solutionBtn.disabled = true;

      try {
        const response = await fetch('/api/create-solution', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            business_name: businessName,
            industry: industry,
            client_need: clientNeed,
            account_id: businessName,
            context: {
              business_type: industry,
              timestamp: new Date().toISOString()
            }
          })
        });

        const result = await response.json();
        
        if (result.success) {
          addChatMessage('assistant', `🎯 **Custom Solution Created!**\n\n${result.result}`);
          showSuccessMessage('Your custom automation solution is ready!');
        } else {
          throw new Error(result.error || 'Failed to create solution');
        }
      } catch (error) {
        addChatMessage('assistant', `❌ **Solution Creation Error**: ${error.message}\n\nPlease try again or contact support.`);
      } finally {
        solutionBtn.innerHTML = originalText;
        solutionBtn.disabled = false;
      }
    }

    async function showWebsiteBuilderModal() {
      console.log('🌐 Website Builder clicked!');
      
      const businessName = accountEl.value.trim() || 'My Business';
      const industry = currentBusinessType || 'general';

      console.log('Business:', businessName, 'Industry:', industry);

      // First, get business details
      const businessDescription = prompt(`🌐 AI Website Builder\n\nFirst, tell me about your business!\n\nWhat does "${businessName}" do? What industry are you in?\n\nExample: "We're a local bakery specializing in artisan breads and pastries" or "Digital marketing agency helping small businesses grow online"\n\nYour business description:`);

      if (!businessDescription) {
        console.log('No business description provided');
        return;
      }

      const websiteType = prompt(`🌐 Website Type Selection\n\nBusiness: ${businessName}\nDescription: ${businessDescription}\n\nWhat type of website do you want?\n\n1. Landing Page - Single page with contact form\n2. Full Website - Multiple pages with navigation\n3. Blog Site - Website with integrated blog system\n4. E-commerce - Online store with shopping cart\n\nEnter your choice (1-4):`);

      console.log('Website type selected:', websiteType);

      if (!websiteType || !['1', '2', '3', '4'].includes(websiteType)) {
        console.log('Invalid or no website type selected');
        return;
      }

      const typeMap = {
        '1': 'landing_page',
        '2': 'full_website', 
        '3': 'blog',
        '4': 'ecommerce'
      };

      const domain = prompt(`Domain name (optional):\n\nExample: myawesomebusiness.com\n\nLeave blank for auto-generated domain:`);

      // Show loading state
      const websiteBtn = document.getElementById('build-website');
      const originalText = websiteBtn.innerHTML;
      websiteBtn.innerHTML = '🏗️ Building...';
      websiteBtn.disabled = true;

      try {
        const requestData = {
          business_name: businessName,
          industry: industry,
          business_description: businessDescription,
          type: typeMap[websiteType],
          style: 'modern',
          features: ['contact_form', 'analytics', 'seo'],
          include_blog: websiteType === '3' || websiteType === '2',
          domain: domain || null,
          account_id: businessName
        };
        
        console.log('📡 Sending request to /api/create-website:', requestData);
        
        // Show progress message after 10 seconds
        const progressTimer = setTimeout(() => {
          if (websiteBtn.innerHTML.includes('Building')) {
            websiteBtn.innerHTML = '🧠 AI is designing your website...';
            addChatMessage('assistant', '🎨 **Website Creation in Progress**\n\nAiden is analyzing your business and designing a custom website. This may take 1-2 minutes as I create:\n\n• Custom HTML/CSS/JavaScript\n• Responsive design\n• SEO optimization\n• Contact forms\n• Professional styling\n\nPlease wait while I craft your perfect website! ✨');
          }
        }, 10000);
        
        const response = await fetch('/api/create-website', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(requestData)
        });
        
        clearTimeout(progressTimer); // Clear the progress timer
        
        console.log('📊 Response status:', response.status);
        console.log('📄 Response headers:', [...response.headers.entries()]);

        console.log('📥 Processing response...');
        const result = await response.json();
        console.log('📋 Response data:', result);
        
        if (result.success) {
          console.log('✅ Website creation successful!');
          
          // Show the full result, but format it nicely
          const websiteContent = result.result;
          const displayContent = websiteContent.length > 2000 
            ? websiteContent.substring(0, 2000) + '\n\n... [Website code continues - full code generated successfully!] ...'
            : websiteContent;
          
          addChatMessage('assistant', `🌐 **Website Created Successfully!**\n\n${displayContent}\n\n✅ Your complete website has been generated! This includes:\n• Full HTML structure\n• Responsive CSS styling\n• Interactive JavaScript\n• Contact forms\n• SEO optimization\n• Professional design\n\n🚀 Ready to deploy to a live domain!`);
          
          showSuccessMessage('Your professional website has been created!');
          
          // Offer to show the full code
          setTimeout(() => {
            if (confirm('Would you like to download the complete website files?')) {
              downloadWebsiteFiles(businessName, websiteContent);
            }
          }, 2000);
        } else {
          console.error('❌ Website creation failed:', result);
          throw new Error(result.error || 'Failed to create website');
        }
      } catch (error) {
        console.error('❌ Website creation error:', error);
        addChatMessage('assistant', `❌ **Website Creation Error**: ${error.message}\n\nPlease try again or contact support.`);
      } finally {
        websiteBtn.innerHTML = originalText;
        websiteBtn.disabled = false;
      }
    }

    async function generateBusinessReport() {
      const businessName = accountEl.value.trim() || 'My Business';
      const industry = currentBusinessType || 'general';

      if (!businessName || businessName === 'My Business') {
        alert('Please enter your business name first!');
        accountEl.focus();
        return;
      }

      // Show loading state
      const reportBtn = document.getElementById('generate-report');
      const originalText = reportBtn.innerHTML;
      reportBtn.innerHTML = '📈 Generating...';
      reportBtn.disabled = true;

      try {
        const response = await fetch('/api/generate-report', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            business_name: businessName,
            industry: industry,
            account_id: businessName
          })
        });

        const result = await response.json();
        
        if (result.success) {
          addChatMessage('assistant', `📊 **Business Intelligence Report**\n\n${result.result}`);
          showSuccessMessage('Business report generated successfully!');
        } else {
          throw new Error(result.error || 'Business not initialized - start a conversation first!');
        }
      } catch (error) {
        if (error.message.includes('Business not initialized')) {
          addChatMessage('assistant', `💡 **Getting Started Required**\n\nTo generate a business report, please:\n1. Enter your business name above\n2. Start a conversation with Aiden\n3. Let Aiden learn about your business needs\n\nOnce Aiden knows your business, comprehensive reports will be available!`);
        } else {
          addChatMessage('assistant', `❌ **Report Generation Error**: ${error.message}\n\nPlease try again or contact support.`);
        }
      } finally {
        reportBtn.innerHTML = originalText;
        reportBtn.disabled = false;
      }
    }

    function showSuccessMessage(message) {
      // Create a temporary success notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, var(--accent-green), #059669);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
      `;
      notification.textContent = `✅ ${message}`;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in forwards';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    function downloadWebsiteFiles(businessName, websiteContent) {
      // Create a downloadable HTML file
      const blob = new Blob([websiteContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${businessName.replace(/[^a-zA-Z0-9]/g, '_')}_website.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      addChatMessage('assistant', `📁 **Website Downloaded!**\n\nYour complete website has been downloaded as:\n\`${a.download}\`\n\nThis file contains your full website with all HTML, CSS, and JavaScript code. You can:\n• Open it in any web browser to preview\n• Upload it to any web hosting service\n• Customize the code further as needed\n\n🚀 Your website is ready to go live!`);
    }

  </script>
</body>
</html>